[[IoT]]

**MQTT** (*Message Queue Telemetry Transport*) - легкий, компактный и открытый протокол обмена данными созданный для передачи данных на удаленных локациях, где требуется небольшой размер кода и есть ограничения по пропускной способности канала.

Вышеперечисленные достоинства позволяют применять его в системах M2M (Машинно-Машинное взаимодействие) и IIoT (Промышленный Интернет вещей).

## Особенности протокола

- Асинхронный протокол
- Компактные сообщения
- Работа в условиях нестабильной связи на линии передачи данных
- Поддержка нескольких уровней качества обслуживания (QoS)
- Легкая интеграция новых устройств

Протокол MQTT работает на прикладном уровне поверх `TCP/IP` и использует по умолчанию 1883 порт (8883 при подключении через `SSL`)

![[Pasted image 20250207125938.png | 600]]

Обмен сообщениями в протоколе MQTT осуществляется между клиентом (*client*), который может быть издателем или подписчиком (`publisher/subscriber`) сообщений, и брокером     (`broker`) сообщений, например `Mosquitto MQTT`. Издатель отправляет данные на `MQTT брокер`, указывая опеределнную тему (*topic*). Подписчики могут получать разные данные от множества издателей в зависимости от подписки на соответствующие топики. 

Устройства MQTT используют определенные типы сообщений для взаимодействия с брокером:
- `Connect` - установить соединение с брокером
- `Disconnect` - разорвать соединение с брокером
- `Publish` - опубликовать данные в топик на брокере
- `Subscribe` - подписаться на топик на брокере
- `Unsubscribe` - отписаться от топика

![[Pasted image 20250207130942.png]]
## Семантика топиков

Топики представляют собой символы с кодировкой UTF-8. Иерархическая структура топиков имеет формат "дерева", что упрощает их организацию и доступ к данным. Топики состоят из одного или нескольких уровней, которые разделены между собой символом "/".
Пример топика в который датчик температуры, расположенный в спальной комнате публикует данные брокеру:
`/home/living-space/living-room1/temperature`

Подписчик может так же получать данные сразу с нескольких топиков, для этого существуют **wildcard**. Они бывают двух типов: одноуровневые и многоуровневые. 

- **Одноуровневый wildcard**. Для его использования применяется символ "+".
	К примеру, нам необходимо получить данные о температуре во всех спальных комнатах:
	`/home/living-space/+/temperature`
	В результате получаем данные с топиков:
	`/home/living-space/living-room1/temperature`
	`/home/living-space/living-room2/temperature`
	`/home/living-space/living-room3/temperature`
- **Многоуровневый wildcard.** Для его использования применяется символ "#".
	К примеру, чтобы получить данные с различных датчиков всех спален в доме;
	`/home/living-space/#`
	В результате получаем данные с топиков:
	`/home/living-space/living-room1/temperature`
	`/home/living-space/living-room1/light1`
	`/home/living-space/living-room1/ligh2`
	`/home/living-space/living-roo1/humidity`
	`/home/living-space/living-room2/temperature`
	`...`
## Структура сообщений

MQTT сообщений состоит из нескольких частей:
- **Фиксированный заголовок** (присутствует во всех сообщениях)
- **Переменный заголовок** (присутствует только в определенных сообщениях)
- **Данные, "нагрузка"** (присутствует только в определенных сообщениях)
### Фиксированный заголовок

![[Pasted image 20250207134038.png]]

`Message type` - тип сообщения, например: `CONNECTION`, `SUBSCRIBE`, `PUBLISH`, и другие.
`Flags specific to each MQTT packet` - эти 4 бита отведены под вспомогательные флаги, наличие и состояние которых зависит от типа сообщения.
`Remaining Length` - представляет длину текущего сообщения (переменный заголовок + данные), может занимать от 1 до 4 байта.