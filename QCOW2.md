[[VIRTUALIZATION]] [[OS]]

>[!info] Definition
>**QCOW2** (QEMU Copy-On-Write version 2) - это формат файловых образов дисков, разработанный специально для использования с QEMU. 

## Copy-On-Write

>[!info] Definition
> **Copy-On-Write** - технология управления ресурсами, которая позволяет эффективно использовать дисковое пространство и память, откладывая копирование данных до момента, когда это действительно необходимо. Эта концепция широко используется в файловых системах, виртуализации и управлении памятью.

### Принцип работы Copy-On-Write

#### Базовый образ (Backing file)
В COW используется **базовый образ**, который содержит исходные данные. Этот образ может быть доступен только для чтения.
#### Новый образ (Overlay)
Создается **новый образ** (*overlay*), который изначально не содержит данные. Вместо этого он ссылается на базовый образ
#### Чтение данных
Когда виртуальная машина или приложение запрашивает данные, они сначала ищутся в новом образе, если данные отсутствуют, они считываются из базового образа.
#### Запись данных
Когда происходит запись данных, они сохраняются в новом образе, а не в базовом. Таким образом, базовый остается неизменным, а все изменения записываются в новый образ.
### Преимущества Copy-On-Write
#### Экономия места
Поскольку новый образ изначально пуст и ссылается на базовый, он занимает очень мало места на диске. Место выделяется только при записи новых данных.
#### Изоляция изменений
Все изменения сохраняются в новом образе, что позволяет изолировать их от базового образа. Это полезно для тестирования, разработки и создания snapshots.
#### Быстрое создание образов
Создание нового COW-образа происходит мгновенно, так как не требуется копирование данных из базового образа.
#### Многократное использование базового образа
Один базовый образ может использоваться для создания множества новых образов, что экономит место и упрощает управление.
### Применение Copy-On-Write
#### Виртуализация
COW используется в форматах образов дисков, таких как QCOW2, для создание легковесных виртуальных машин, которые могут быстро развертываться и изолировать изменения.
#### Snapshots
COW позволяет создавать **моментальные снимки** (*snapshots*) состояния виртуальной машины. Каждый snapshot - это новый COW-образ, который ссылается на предыдущий.
#### Файловые системы
Некоторые файловые системы (Например, Btfs, ZFS) используют COW для обеспечения целостности данных и поддержки snapshots.
#### Управление памятью
В операционных системах COW используется для оптимизации использования памяти, например, при создании новых процессов (fork).
## Особенности QCOW2
#### Динамическое выделение памяти (Sparse File)
QCOW2-образы занимают только то место на диске, которое фактически используются данными. Например, если вы создаете образ на 100 ГБ, но записываете только 10 ГБ данных, файл будет занимать примерно 10 ГБ. Это позволяет экономить место на диске, особенно при создании больших образов.
#### Snapshots
QCOW2 поддерживает создание **моментальных снимков** (snapshots) состояния виртуальной машины. Это позволяет сохранять текущее состояние виртуальной машины и вернуться к нему позже. Snapshots полезны для тестирования, отката изменений или создания резервных копий.
#### Сжатие данных
QCOW2 поддерживает сжатие данных, что позволяет уменьшить размер образа. Это особенно полезно для образов, содержащих много пустого пространства или легко сжимаемых данных.
#### Шифрование
QCOW2 поддерживает шифрование данных, что обеспечивает защиту конфиденциальной информации. Шифрование выполняется на уровне образа диска.
#### Поддержка нескольких образов (Backing Files)
QCOW2 позволяет использовать **базовые образы** (*backing files*). Это означает, что вы можете создать новый образ, который будет использовать данные из другого образа (базового), но записывать изменения только в новый файл. Это полезно для создания нескольких виртуальных машин на основе одного базового образа, что экономит место и упрощает управление.
#### Оптимизация для QEMU/KVM
QCOW2 разработан специально для использования с QEMU/KVM, что обеспечивает высокую производительность и интеграцию с этими инструментами.
## Использование QCOW2
### Создание QCOW2-образа

```shell
qemu-img create -f qcow2 miyimage.qcow 10G
```

Эта команда создаст QCOW2-образ размером 10 ГБ, он изначально пуст. Это **пустой виртуальный диск**. 
### Установка ОС в QCOW2
#### Установка ОС с нуля

```shell
qemu-system-x86_64 \
 -hda myimage.qcow2 \
 -cdrom installation.iso \
 -m 2048 \
 -smp 2
```

Этот способ используется QCOW-2 образ как виртуальный диск для установки операционной системы с ISO-образа с ОС. Эта команда запускает виртуальную машину с QCOW2-образом и ISO-образом. Далее нужно будет просто установить ОС так же, как на физический диск.
#### Копирование ОС из другого образа

```shell
qemu-img conver convert -f raw -O qcow2 input.raw output.qcow2
```

Если уже есть готовый образ диска с операционной системой (например в формате RAW или QCOW2), то можно конвертировать его в QCOW2.
Теперь `output.qcow2` будет содержать ОС из `input.raw`.
### Конвертация в QCOW2

```shell
qemu-img convert -f raw -O qcow input.raw output.qcow2
```

Можно конвертировать другие форматы.
### Использование базового образа

```shell
qemu-img create -f qcow2 -b base_image.qcow2 new_image.qcow2
```

Эта команда создает новый QCOW2-образ на основе базового образа.
### Создание snapshot

```shell
qemu-img snapshot -c snaphot_name myimage.qcow2
```

Эта команда создает snapshot (моментальный снимок состояния виртуальной машины).
### Просмотр информации об образе

```shell
qemu-img info myimage.qcow2
```

Эта команда позволяет посмотреть информацию об QCOW2-образе (размер, сжатие, snapshots, ...).
### Пример использования QCOW2 с QEMU

```shell
qemu-system-x86_64 \
 -hda myimage.qcow2 \
 -m 2048 \
 -smp 2
```

Эта команда запускает виртуальную машину с QCOW2-образом.
#### Разбор команды
`qemu-system-x86_64` - команда для запуска QEMU с эмуляцией архитектуры x86_64 (64-битная архитектура Intel/AMD).
`-hda myimage.qcow2`:
- Параметр `-hda` указывает QEMU использовать файл `myimage.qcow2` в качестве основного жесткого диска (виртуального диска) для виртуальной машины.
- `myimage.qcow2` - это QCOW2-образ, который содержит операционную систему или данные.
`-m 2048` - параметр `-m` задает объем оперативной памяти (RAM) для виртуальной машины. В данном случае выделяется 2048 МБ памяти.
`-smp 2` - параметр `-smp` указывает количество процессоров (CPU) для виртуальной машины. В данном случае используется **2 виртуальных CPU**.  